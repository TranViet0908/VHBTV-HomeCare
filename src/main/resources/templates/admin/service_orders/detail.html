<!-- templates/admin/service_orders/detail.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Chi tiết đơn dịch vụ - VHBTV Homecare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
<div class="flex">
  <!-- Sidebar -->
  <div th:replace="/admin/fragments/sidebar :: sidebar"></div>

  <!-- Nội dung -->
  <div class="flex-1 min-h-screen ml-64">
    <!-- Header -->
    <div th:replace="/admin/fragments/header :: header"></div>

    <!-- Main -->
    <main class="p-6"
          th:with="
            createdAtTxt=${order != null && order.createdAt != null ? #temporals.format(order.createdAt,'dd/MM/yyyy HH:mm') : '—'},
            updatedAtTxt=${order != null && order.updatedAt != null ? #temporals.format(order.updatedAt,'dd/MM/yyyy HH:mm') : '—'}
          ">

      <!-- Tiêu đề + đổi trạng thái -->
      <div class="mb-6 flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">
            Đơn <span class="text-indigo-600" th:text="${order.orderCode}">SO-XXXXX</span>
          </h1>
          <p class="text-sm text-gray-500">ID: <span th:text="${order.id}">0</span></p>
        </div>

        <form th:action="@{|/admin/service-orders/${order.id}/status|}" method="post" class="flex items-center gap-2">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <select name="value" class="rounded-lg border-gray-300">
            <option value="PENDING"     th:selected="${order.status=='PENDING'}">PENDING</option>
            <option value="CONFIRMED"   th:selected="${order.status=='CONFIRMED'}">CONFIRMED</option>
            <option value="IN_PROGRESS" th:selected="${order.status=='IN_PROGRESS'}">IN_PROGRESS</option>
            <option value="COMPLETED"   th:selected="${order.status=='COMPLETED'}">COMPLETED</option>
            <option value="CANCELLED"   th:selected="${order.status=='CANCELLED'}">CANCELLED</option>
            <option value="REFUNDED"    th:selected="${order.status=='REFUNDED'}">REFUNDED</option>
          </select>
          <button class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Cập nhật</button>
        </form>
      </div>

      <!-- Thông tin đơn (ServiceOrder) -->
      <section class="grid gap-4 md:grid-cols-3">
        <!-- Trạng thái & thời gian -->
        <div class="bg-white rounded-xl border p-4">
          <div class="text-sm text-gray-500">Trạng thái</div>
          <div class="mt-1">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                  th:classappend="${
                    order.status}=='COMPLETED' ? ' bg-green-100 text-green-800' :
                    (${order.status}=='PENDING' ? ' bg-yellow-100 text-yellow-800' :
                    (${order.status}=='CANCELLED' ? ' bg-red-100 text-red-800' : ' bg-blue-100 text-blue-800'))"
                  th:text="${order.status}">CONFIRMED</span>
          </div>
          <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
            <div class="text-gray-500">Tạo lúc</div><div class="text-gray-900" th:text="${createdAtTxt}">—</div>
            <div class="text-gray-500">Cập nhật</div><div class="text-gray-900" th:text="${updatedAtTxt}">—</div>
          </div>
        </div>

        <!-- Tổng tiền -->
        <div class="bg-white rounded-xl border p-4">
          <div class="text-sm text-gray-500">Tổng tiền</div>
          <div class="mt-2 text-2xl font-bold text-gray-900"
               th:text="${order.total != null ? #numbers.formatDecimal(order.total,0,'POINT',0,'POINT') + ' ₫' : '0 ₫'}">0 ₫</div>
          <div class="mt-2 text-sm text-gray-600">
            Subtotal:
            <span th:text="${order.subtotal != null ? #numbers.formatDecimal(order.subtotal,0,'POINT',0,'POINT') + ' ₫' : '0 ₫'}">0 ₫</span>
            • Giảm:
            <span th:text="${order.discountAmount != null ? #numbers.formatDecimal(order.discountAmount,0,'POINT',0,'POINT') + ' ₫' : '0 ₫'}">0 ₫</span>
          </div>
          <div class="mt-2 text-sm text-gray-600">Coupon ID: <span th:text="${order.couponId}">—</span></div>
          <div class="mt-2 text-sm text-gray-600">Order code: <span th:text="${order.orderCode}">—</span></div>
        </div>

        <!-- Khách & Vendor + liên hệ -->
        <div class="bg-white rounded-xl border p-4">
          <div class="text-sm text-gray-500">Khách, Vendor, liên hệ</div>
          <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
            <div class="text-gray-500">Customer ID</div><div class="text-gray-900" th:text="${order.customerId}">—</div>
            <div class="text-gray-500">Vendor ID</div><div class="text-gray-900" th:text="${order.vendorId}">—</div>
            <div class="text-gray-500">Tên liên hệ</div><div class="text-gray-900" th:text="${order.contactName}">—</div>
            <div class="text-gray-500">SĐT</div><div class="text-gray-900" th:text="${order.contactPhone}">—</div>
            <div class="text-gray-500">Địa chỉ</div><div class="text-gray-900" th:text="${order.addressLine}">—</div>
          </div>
        </div>
      </section>

      <!-- Cập nhật liên hệ -->
      <section class="mt-6 bg-white rounded-xl border p-4">
        <h2 class="text-lg font-semibold mb-3">Cập nhật thông tin liên hệ</h2>
        <form id="update-contact-form" th:action="@{|/admin/service-orders/${order.id}/contact|}" method="post" class="grid gap-4 md:grid-cols-4">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
          <div>
            <label class="text-sm text-gray-600">Tên liên hệ</label>
            <input name="contactName" th:value="${order.contactName}" class="mt-1 w-full rounded-lg border-gray-300"/>
          </div>
          <div>
            <label class="text-sm text-gray-600">SĐT</label>
            <input name="contactPhone" th:value="${order.contactPhone}" class="mt-1 w-full rounded-lg border-gray-300"/>
          </div>
          <div class="md:col-span-2">
            <label class="text-sm text-gray-600">Địa chỉ</label>
            <input name="addressLine" th:value="${order.addressLine}" class="mt-1 w-full rounded-lg border-gray-300"/>
          </div>
          <div class="md:col-span-4">
            <label class="text-sm text-gray-600">Ghi chú</label>
            <textarea name="notes" rows="3" class="mt-1 w-full rounded-lg border-gray-300"
                      th:text="${order.notes}"></textarea>
          </div>
          <div class="md:col-span-4">
            <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Lưu thông tin</button>
          </div>
        </form>
      </section>

      <!-- Hạng mục dịch vụ (ServiceOrderItem) -->
      <section class="mt-6 bg-white rounded-xl border overflow-hidden">
        <div class="p-4 border-b flex items-center justify-between">
          <h2 class="text-lg font-semibold">Hạng mục dịch vụ</h2>
        </div>
        <div class="p-4 overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Item ID</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Dịch vụ</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor ID</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lịch hẹn</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">SL</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Đơn giá</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Thành tiền</th>
              <th class="px-4 py-3"></th>
            </tr>
            </thead>

            <tbody class="divide-y divide-gray-100" th:if="${items != null and !#lists.isEmpty(items)}">
            <tr th:each="it : ${items}">
              <td class="px-4 py-3 text-gray-700" th:text="${it.id}">—</td>
              <td class="px-4 py-3">
                <!-- Bỏ vendorService.name để tránh lỗi proxy -->
                <div class="font-medium text-gray-900">
                  Dịch vụ của Vendor <span th:text="${it.vendorId}">—</span>
                </div>
                <div class="text-xs text-gray-500">
                  Thuộc đơn: <span th:text="${it.serviceOrderId}">—</span>
                </div>
              </td>
              <td class="px-4 py-3 text-gray-700" th:text="${it.vendorId}">—</td>
              <td class="px-4 py-3 text-gray-700" th:text="${#temporals.format(it.scheduledAt,'dd/MM/yyyy HH:mm')}">—</td>
              <td class="px-4 py-3 text-right" th:text="${it.quantity}">1</td>
              <td class="px-4 py-3 text-right"
                  th:text="${it.unitPrice != null ? #numbers.formatDecimal(it.unitPrice,0,'POINT',0,'POINT') + ' ₫' : '0 ₫'}">0 ₫</td>
              <td class="px-4 py-3 text-right font-semibold"
                  th:text="${it.subtotal != null ? #numbers.formatDecimal(it.subtotal,0,'POINT',0,'POINT') + ' ₫' : '0 ₫'}">0 ₫</td>
              <td class="px-4 py-3 text-right">
                <form th:action="@{|/admin/service-orders/${order.id}/items/${it.id}/delete|}" method="post"
                      onsubmit="return confirm('Xóa hạng mục này?')">
                  <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                  <button class="px-3 py-1.5 rounded bg-red-600 text-white hover:bg-red-700">Xóa</button>
                </form>
              </td>
            </tr>
            </tbody>

            <tbody th:if="${items == null or #lists.isEmpty(items)}">
            <tr><td colspan="8" class="px-4 py-6 text-center text-gray-500">Chưa có hạng mục.</td></tr>
            </tbody>

            <tfoot class="bg-gray-50">
            <tr>
              <td colspan="5"></td>
              <td class="px-4 py-3 text-right text-sm text-gray-600">Subtotal</td>
              <td class="px-4 py-3 text-right font-semibold"
                  th:text="${order.subtotal != null ? #numbers.formatDecimal(order.subtotal,0,'POINT',0,'POINT') + ' ₫' : '0 ₫'}">0 ₫</td>
              <td></td>
            </tr>
            <tr>
              <td colspan="5"></td>
              <td class="px-4 py-3 text-right text-sm text-gray-600">Giảm</td>
              <td class="px-4 py-3 text-right font-semibold"
                  th:text="${order.discountAmount != null ? #numbers.formatDecimal(order.discountAmount,0,'POINT',0,'POINT') + ' ₫' : '0 ₫'}">0 ₫</td>
              <td></td>
            </tr>
            <tr>
              <td colspan="5"></td>
              <td class="px-4 py-3 text-right text-sm text-gray-800">Tổng</td>
              <td class="px-4 py-3 text-right text-lg font-bold text-gray-900"
                  th:text="${order.total != null ? #numbers.formatDecimal(order.total,0,'POINT',0,'POINT') + ' ₫' : '0 ₫'}">0 ₫</td>
              <td></td>
            </tr>
            </tfoot>
          </table>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <div th:replace="/admin/fragments/footer :: footer"></div>
  </div>
</div>
  <script src="/js/validate/core.js"></script>
  <script src="/js/validate/admin-service-order-contact-validator.js"></script>
</body>
</html>
