<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Đăng ký - 5PLUS ONLINE</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *{font-family:'Inter',sans-serif}
        .hero-pattern{background-image:radial-gradient(circle at 25% 25%,#667eea 0%,transparent 50%),radial-gradient(circle at 75% 75%,#764ba2 0%,transparent 50%)}
        .glass-effect{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.2)}
        .card-hover{transition:all .3s ease}
        .card-hover:hover{transform:translateY(-5px);box-shadow:0 25px 50px rgba(0,0,0,.15)}
        .error-text{font-size:12px;color:#dc2626;margin-top:4px}
        .is-invalid{border-color:#dc2626!important;background-color:rgba(220,38,38,.04)}
        .is-valid{border-color:#16a34a!important;background-color:rgba(22,163,74,.04)}
    </style>
</head>
<body class="hero-pattern min-h-screen flex items-center justify-center">
<header class="fixed top-0 left-0 w-full bg-gradient-to-r from-blue-600 to-purple-700 shadow-md z-50">
    <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
        <a class="flex items-center space-x-2 text-white font-bold text-xl" href="/"><i class="fas fa-plus-circle"></i><span>5PLUS ONLINE</span></a>
        <nav class="hidden md:flex items-center space-x-8">
            <a class="text-gray-200 hover:text-white" href="/">Trang chủ</a>
            <a class="text-gray-200 hover:text-white" href="/about">Giới thiệu</a>
            <a class="text-gray-200 hover:text-white" href="/contact">Liên hệ</a>
        </nav>
        <div class="flex items-center space-x-4">
            <a class="bg-yellow-400 text-gray-900 px-4 py-2 rounded-xl font-semibold" href="/register">Đăng ký</a>
            <a class="bg-white/20 text-white px-4 py-2 rounded-xl border border-white/30" href="/login">Đăng nhập</a>
        </div>
    </div>
</header>

<div class="container mx-auto px-4">
    <div class="max-w-md mx-auto">
        <div class="text-center mb-8">
            <div class="text-3xl font-bold text-white mb-2"><i class="fas fa-plus-circle mr-2"></i>5PLUS ONLINE</div>
            <p class="text-black-200">Tạo tài khoản mới</p>
        </div>

        <div class="glass-effect rounded-2xl p-8 card-hover">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user-plus text-2xl text-white"></i>
                </div>
                <h2 class="text-2xl font-bold text-white">Đăng ký</h2>
            </div>

            <div class="bg-red-500/20 border border-red-500/30 text-red-100 px-4 py-3 rounded-xl mb-4" th:if="${error}">
                <div class="flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i><span th:text="${error}"></span></div>
            </div>
            <div class="bg-green-500/20 border border-green-500/30 text-green-100 px-4 py-3 rounded-xl mb-4" th:if="${param.success}">
                <div class="flex items-center"><i class="fas fa-check-circle mr-2"></i><span>Đăng ký thành công! Vui lòng đăng nhập.</span></div>
            </div>

            <form id="registerForm" class="space-y-4" method="post" enctype="multipart/form-data" th:action="@{/register}" novalidate>
                <input type="hidden" name="_csrf" th:value="${_csrf.token}">

                <div data-field="username">
                    <label class="block text-sm mb-1">Tên đăng nhập *</label>
                    <input class="w-full border rounded-lg p-2.5" name="username" placeholder="vd: tranviet" required th:value="${username}">
                    <p class="error-text"></p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div data-field="password">
                        <label class="block text-sm mb-1">Mật khẩu *</label>
                        <input class="w-full border rounded-lg p-2.5" name="password" placeholder="Ít nhất 6 ký tự" required type="password">
                        <p class="error-text"></p>
                    </div>
                    <div data-field="passwordConfirm">
                        <label class="block text-sm mb-1">Xác nhận mật khẩu *</label>
                        <input class="w-full border rounded-lg p-2.5" name="passwordConfirm" placeholder="Nhập lại mật khẩu" required type="password">
                        <p class="error-text"></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div data-field="email">
                        <label class="block text-sm mb-1">Email *</label>
                        <input class="w-full border rounded-lg p-2.5" name="email" placeholder="you@example.com" required type="email" th:value="${email}">
                        <p class="error-text"></p>
                    </div>
                    <div data-field="phone">
                        <label class="block text-sm mb-1">Số điện thoại *</label>
                        <input class="w-full border rounded-lg p-2.5" name="phone" placeholder="09xx xxx xxx" required th:value="${phone}">
                        <p class="error-text"></p>
                    </div>
                </div>

                <div data-field="avatar">
                    <label class="block text-sm mb-1">Ảnh đại diện</label>
                    <input accept="image/*" class="w-full file:mr-3 file:px-4 file:py-2 file:rounded-lg file:border-0 file:bg-blue-600 file:text-white border rounded-lg p-2.5" id="avatar" name="avatar" type="file">
                    <p class="error-text"></p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div data-field="fullName">
                        <label class="block text-sm mb-1">Họ và tên *</label>
                        <input class="w-full border rounded-lg p-2.5" name="fullName" placeholder="Ví dụ: Nguyễn Văn A" th:value="${fullName}" required>
                        <p class="error-text"></p>
                    </div>
                    <div data-field="dob">
                        <label class="block text-sm mb-1">Ngày sinh *</label>
                        <input class="w-full border rounded-lg p-2.5" name="dob" th:value="${dob}" type="date" required>
                        <p class="error-text"></p>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div data-field="gender">
                        <label class="block text-sm mb-1">Giới tính</label>
                        <select class="w-full border rounded-lg p-2.5" name="gender" th:value="${gender}">
                            <option value="">-- Chọn --</option>
                            <option value="MALE">Nam</option>
                            <option value="FEMALE">Nữ</option>
                            <option value="OTHER">Khác</option>
                        </select>
                        <p class="error-text"></p>
                    </div>
                    <div data-field="addressLine">
                        <label class="block text-sm mb-1">Địa chỉ *</label>
                        <input class="w-full border rounded-lg p-2.5" name="addressLine" placeholder="Số nhà, đường, phường/xã..." th:value="${addressLine}" required>
                        <p class="error-text"></p>
                    </div>
                </div>

                <button id="btnSubmit" class="w-full py-2.5 rounded-lg bg-gray-900 text-white" type="submit">Đăng ký</button>
            </form>

            <div class="text-center mt-8 text-black-300">
                <p style="margin-top: -20px">&copy; 2025 5PLUS ONLINE. Tất cả quyền được bảo lưu.</p>
            </div>
        </div>
    </div>
</div>

<script>
    (() => {
        const form = document.getElementById('registerForm');

        // Regex chuẩn: hỗ trợ chữ có dấu tiếng Việt
        const re = {
            username: /^[A-Za-z0-9_]+$/,
            email: /^[A-Za-z0-9]+(?:[A-Za-z0-9.]*[A-Za-z0-9])?@[A-Za-z0-9]+(?:\.[A-Za-z0-9]+)+$/,
            phone: /^\d{10,11}$/,
            fullName: /^[\p{L} ]+$/u
        };

        const fields = ['username','password','passwordConfirm','email','phone','fullName','dob','addressLine'];

        function setFieldState(input, msg) {
            const wrap = input.closest('[data-field]');
            const err = wrap ? wrap.querySelector('.error-text') : null;
            input.classList.remove('is-invalid','is-valid');
            if (msg) {
                input.classList.add('is-invalid');
                if (err) err.textContent = msg;
            } else {
                if (err) err.textContent = '';
                if (input.value.trim() !== '') input.classList.add('is-valid');
            }
        }

        function validateField(name) {
            const el = form.elements[name];
            if (!el) return null;
            const val = (el.value || '').trim();

            switch (name) {
                case 'username':
                    if (!val) return 'Bắt buộc.';
                    if (!re.username.test(val)) return 'Chỉ chữ, số, gạch dưới.';
                    return null;
                case 'password':
                    if (!val) return 'Bắt buộc.';
                    if (val.length < 6) return 'Tối thiểu 6 ký tự.';
                    return null;
                case 'passwordConfirm': {
                    const pw = (form.elements['password'].value || '').trim();
                    if (!val) return 'Bắt buộc.';
                    if (val !== pw) return 'Không trùng mật khẩu.';
                    return null;
                }
                case 'email':
                    if (!val) return 'Bắt buộc.';
                    if (!re.email.test(val)) return 'Email không hợp lệ.';
                    return null;
                case 'phone':
                    if (!val) return 'Bắt buộc.';
                    if (!re.phone.test(val)) return 'SĐT 10-11 chữ số.';
                    return null;
                case 'fullName':
                    if (!val) return 'Bắt buộc.';
                    if (!re.fullName.test(val)) return 'Chỉ chữ và khoảng trắng.';
                    return null;
                case 'dob': {
                    if (!val) return 'Bắt buộc.';
                    const d = new Date(val);
                    const [y,m,dd] = val.split('-').map(Number);
                    const validYmd = d.getFullYear()===y && (d.getMonth()+1)===m && d.getDate()===dd;
                    const min = new Date('1900-01-01');
                    const today = new Date();
                    if (!validYmd || d < min || d > today) return 'Ngày sinh 1900 → hôm nay, ngày hợp lệ.';
                    return null;
                }
                case 'addressLine': {
                    if (!val) return 'Bắt buộc.';
                    const hasAlphaNum = /[\p{L}\d]/u.test(val);
                    if (!hasAlphaNum) return 'Không chỉ ký tự đặc biệt.';
                    return null;
                }
                default:
                    return null;
            }
        }

        // Báo đỏ ngay khi nhập
        [...fields, 'gender'].forEach(name => {
            const el = form.elements[name];
            if (!el) return;
            const evt = (name === 'dob' || el.tagName === 'SELECT') ? 'change' : 'input';
            el.addEventListener(evt, () => {
                const msg = validateField(name);
                setFieldState(el, msg);
                if (name === 'password' || name === 'passwordConfirm') {
                    ['password','passwordConfirm'].forEach(n => {
                        const e2 = form.elements[n];
                        const m2 = validateField(n);
                        setFieldState(e2, m2);
                    });
                }
            });
            el.addEventListener('blur', () => {
                el.value = (el.value || '').trim();
                setFieldState(el, validateField(name));
            });
        });

        // Kiểm tra lần cuối khi submit
        form.addEventListener('submit', (e) => {
            let firstErr = null;
            fields.forEach(name => {
                const el = form.elements[name];
                if (!el) return;
                el.value = (el.value || '').trim();
                const msg = validateField(name);
                setFieldState(el, msg);
                if (!firstErr && msg) firstErr = el;
            });
            if (firstErr) {
                e.preventDefault();
                firstErr.scrollIntoView({behavior:'smooth', block:'center'});
                firstErr.focus({preventScroll:true});
            }
        });
    })();
</script>
</body>
</html>
