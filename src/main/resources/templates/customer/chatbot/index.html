<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Chatbot — VHBTV HomeCare</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}">
    <meta name="_csrf_header" th:content="${_csrf.headerName}">
    <style>
        * { font-family: Inter, sans-serif }
        .chat-box { height: calc(100vh - 320px) }
    </style>
</head>
<body class="bg-gray-50">
<th:block th:replace="~{layouts/header :: siteHeader}"></th:block>

<main class="container mx-auto px-4 lg:px-8 pt-24 pb-16">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl border shadow-sm">
        <div class="px-6 py-4 border-b flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-blue-600 text-white flex items-center justify-center font-bold">S</div>
                <div>
                    <div class="font-semibold">Sana • Trợ lý CSKH</div>
                    <div class="text-xs text-gray-500">Sàn trung gian Customer ↔ Vendor</div>
                </div>
            </div>
            <div class="text-xs text-gray-500">Không xử lý yêu cầu nội bộ hệ thống</div>
        </div>

        <div class="chat-box overflow-y-auto px-4 py-4 space-y-3 bg-gray-50" id="chat"></div>

        <div class="px-4 pt-2 pb-0 flex flex-wrap gap-2">
            <button type="button" class="px-3 py-1.5 text-sm bg-gray-100 rounded-full hover:bg-gray-200 suggestion">Giặt sofa giá khoảng?</button>
            <button type="button" class="px-3 py-1.5 text-sm bg-gray-100 rounded-full hover:bg-gray-200 suggestion">Cách tra cứu đơn đã đặt?</button>
            <button type="button" class="px-3 py-1.5 text-sm bg-gray-100 rounded-full hover:bg-gray-200 suggestion">Vệ sinh điều hòa mất bao lâu?</button>
            <button type="button" class="px-3 py-1.5 text-sm bg-gray-100 rounded-full hover:bg-gray-200 suggestion">Nhà có trẻ nhỏ nên chọn gói nào?</button>
        </div>

        <form id="f" class="p-4 border-t flex items-center gap-3">
            <input class="flex-1 px-4 py-3 border rounded-xl focus:ring-2 focus:ring-blue-500" id="q" name="q"
                   placeholder="Nhập câu hỏi...">
            <button class="px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700" type="submit">
                <i class="fas fa-paper-plane"></i><span class="ml-2">Gửi</span>
            </button>
        </form>
    </div>

    <div class="max-w-4xl mx-auto mt-4 text-xs text-gray-500">
        Sana không hỏi thông tin nhạy cảm. Khi cần tra cứu đơn: Đăng nhập → Đơn hàng của tôi.
    </div>
</main>

<th:block th:replace="~{layouts/footer :: siteFooter}"></th:block>

<script>
    const chat = document.getElementById('chat');
    const form = document.getElementById('f');
    const input = document.getElementById('q');

    function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
    function appendUser(text){
      chat.insertAdjacentHTML('beforeend',
        `<div class="flex items-start gap-3 p-1 justify-end">
           <div class="bg-blue-50 rounded-2xl px-4 py-2 max-w-[80%] whitespace-pre-wrap border border-blue-100">${esc(text)}</div>
           <div class="w-8 h-8 rounded-full bg-gray-800 text-white flex items-center justify-center">U</div>
         </div>`);
      chat.scrollTop = chat.scrollHeight;
    }
    function appendBot(html){
      chat.insertAdjacentHTML('beforeend', html);
      chat.scrollTop = chat.scrollHeight;
    }
    document.querySelectorAll('.suggestion').forEach(b=>b.onclick=()=>{ input.value=b.textContent.trim(); input.focus(); });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = input.value.trim();
      if (!q) return;
      appendUser(q);
      input.value = '';

      const csrf = document.querySelector('meta[name="_csrf"]')?.content;
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;

      const res = await fetch('/customer/chat/send', {
        method: 'POST',
        headers: Object.assign({'Content-Type':'application/json'},
          csrf && csrfHeader ? { [csrfHeader]: csrf } : {}),
        body: JSON.stringify({ message: q })
      });

      let data;
      try { data = await res.json(); }
      catch { appendBot(`<div class="text-red-600 text-sm">BAD_RESPONSE</div>`); return; }

      if (!res.ok || data.error) {
        appendBot(`<div class="text-red-600 text-sm">${esc(data.error || 'ERROR')}</div>`);
        return;
      }
      appendBot(
        `<div class="flex items-start gap-3 p-1">
           <div class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center">S</div>
           <div class="bg-white rounded-2xl px-4 py-2 max-w-[80%] whitespace-pre-wrap border">${esc(data.reply)}</div>
         </div>`
      );
    });
</script>
</body>
</html>
