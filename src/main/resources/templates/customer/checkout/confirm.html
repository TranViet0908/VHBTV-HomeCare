<!-- resources/templates/checkout/confirm.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xác nhận đơn hàng - VHBTV HomeCare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <style>
    .step-active { background:#2563eb;color:#fff; }
    .step-completed { background:#22c55e;color:#fff; }
    .payment-method { border:2px solid #e5e7eb; border-radius:.5rem; padding:1rem; cursor:pointer; transition:.15s; }
    .payment-method:hover { border-color:#93c5fd; background:#eff6ff; }
    .payment-method.selected { border-color:#2563eb; background:#eff6ff; }
  </style>
</head>
<body class="bg-gray-50">
<div th:replace="~{layouts/header :: siteHeader}"></div>

<main class="pt-24 pb-16">
  <div class="container mx-auto px-4 lg:px-8 max-w-6xl">
    <!-- Steps -->
    <div class="mb-12">
      <div class="flex items-center justify-center">
        <div class="flex items-center">
          <div class="flex items-center">
            <div class="w-10 h-10 rounded-full flex items-center justify-center step-completed">
              <i class="fas fa-check"></i>
            </div>
            <span class="ml-2 font-medium text-gray-700">Giỏ hàng</span>
          </div>
          <div class="w-24 h-1 bg-green-500 mx-4"></div>
          <div class="flex items-center">
            <div class="w-10 h-10 rounded-full flex items-center justify-center step-completed">
              <i class="fas fa-check"></i>
            </div>
            <span class="ml-2 font-medium text-gray-700">Thông tin</span>
          </div>
          <div class="w-24 h-1 bg-blue-600 mx-4"></div>
          <div class="flex items-center">
            <div class="w-10 h-10 rounded-full flex items-center justify-center step-active">3</div>
            <span class="ml-2 font-medium text-gray-900">Xác nhận</span>
          </div>
        </div>
      </div>
    </div>

    <form action="/customer/checkout/process" method="post" id="checkoutForm">
      <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden">
      <input type="hidden" name="couponCode" th:value="${couponCode}">
      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Left -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Contact -->
          <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-bold text-gray-900">
                <i class="fas fa-user mr-2 text-blue-600"></i>Thông tin liên hệ
              </h2>
              <a href="/customer/checkout/details" class="text-blue-600 hover:underline text-sm">
                <i class="fas fa-edit mr-1"></i>Chỉnh sửa
              </a>
            </div>
            <div class="grid md:grid-cols-2 gap-4 text-sm">
              <div><span class="text-gray-600">Họ tên:</span>
                <span class="font-medium ml-2" th:text="${contactName}">...</span></div>
              <div><span class="text-gray-600">Điện thoại:</span>
                <span class="font-medium ml-2" th:text="${contactPhone}">...</span></div>
            </div>
          </div>

          <!-- Orders grouped by vendor -->
          <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-6">
              <i class="fas fa-receipt mr-2 text-blue-600"></i>Đơn hàng của bạn
              <span class="text-sm text-gray-500 font-normal">(<span th:text="${#lists.size(ordersByVendor)}">0</span> đơn hàng)</span>
            </h2>

            <div class="mb-6 last:mb-0 pb-6 last:pb-0 border-b last:border-b-0" th:each="order : ${ordersByVendor}">
              <div class="flex items-center gap-3 mb-4 bg-gray-50 p-3 rounded-lg">
                <img th:src="${order.vendorAvatarUrl} ?: @{/images/avatar-default.png}"
                     alt="Vendor" class="w-10 h-10 rounded-full object-cover">
                <div class="flex-1">
                  <h3 class="font-semibold text-gray-900"
                      th:text="${order.vendor != null ? order.vendor.displayName : 'Nhà cung cấp'}">Vendor</h3>
                </div>
              </div>

              <div th:each="item : ${order.items}" class="flex gap-3 mb-3 last:mb-0">
                <img th:src="${item.vendorService?.coverUrl ?: '/placeholder.svg?height=60&width=60'}"
                     alt="Service" class="w-16 h-16 rounded-lg object-cover">
                <div class="flex-1">
                  <h4 class="font-medium text-gray-900 text-sm" th:text="${item.vendorService?.title}">Service</h4>
                  <div class="text-xs text-gray-600 mt-1 space-y-1">
                    <div><i class="fas fa-calendar mr-1"></i>
                      <span th:text="${#temporals.format(item.scheduledAt, 'dd/MM/yyyy HH:mm')}">--/--/---- --:--</span>
                    </div>
                    <div><i class="fas fa-map-marker-alt mr-1"></i>
                      <span th:text="${item.addressLine} ?: 'Địa chỉ chưa có'">Địa chỉ</span>
                    </div>
                    <div th:if="${item.notes}"><i class="fas fa-note-sticky mr-1"></i>
                      <span th:text="${item.notes}">Ghi chú</span></div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-xs text-gray-600">x<span th:text="${item.quantity}">1</span></div>
                  <div class="font-semibold text-blue-600"
                       th:text="${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')} + 'đ'">0đ
                  </div>
                </div>
              </div>

              <div class="mt-4 pt-4 border-t">
                <div class="flex justify-between text-sm mb-2">
                  <span class="text-gray-600">Tạm tính</span>
                  <span th:text="${#numbers.formatDecimal(order.subtotal, 0, 'COMMA', 0, 'POINT')} + 'đ'">0đ</span>
                </div>
                <div class="flex justify-between text-sm text-green-600 mb-2" th:if="${order.discount > 0}">
                  <span>Giảm giá</span>
                  <span th:text="'-' + ${#numbers.formatDecimal(order.discount, 0, 'COMMA', 0, 'POINT')} + 'đ'">-0đ</span>
                </div>
                <div class="flex justify-between font-semibold">
                  <span>Tổng đơn hàng</span>
                  <span class="text-blue-600"
                        th:text="${#numbers.formatDecimal(order.total, 0, 'COMMA', 0, 'POINT')} + 'đ'">0đ</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment -->
          <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-6">
              <i class="fas fa-credit-card mr-2 text-blue-600"></i>Phương thức thanh toán
            </h2>

            <div class="space-y-3">
              <label class="payment-method flex items-center gap-4">
                <input type="radio" name="paymentMethod" value="VNPAY" class="w-5 h-5" checked>
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">VNPAY</div>
                  <div class="text-sm text-gray-600">Thanh toán qua cổng VNPAY</div>
                </div>
                <img src="/placeholder.svg?height=30&width=60" alt="VNPAY" class="h-8">
              </label>

              <label class="payment-method flex items-center gap-4">
                <input type="radio" name="paymentMethod" value="MOMO" class="w-5 h-5">
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">MoMo</div>
                  <div class="text-sm text-gray-600">Ví điện tử MoMo</div>
                </div>
                <img src="/placeholder.svg?height=30&width=60" alt="MoMo" class="h-8">
              </label>

              <label class="payment-method flex items-center gap-4">
                <input type="radio" name="paymentMethod" value="COD" class="w-5 h-5">
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">Thanh toán khi hoàn thành</div>
                  <div class="text-sm text-gray-600">Thanh toán trực tiếp cho nhân viên</div>
                </div>
                <i class="fas fa-money-bill-wave text-3xl text-green-600"></i>
              </label>
            </div>
          </div>
        </div>

        <!-- Right summary -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-xl shadow-sm p-6 sticky top-24">
            <h2 class="text-xl font-bold text-gray-900 mb-6">Tổng thanh toán</h2>

            <div class="space-y-3 mb-6 pb-6 border-b">
              <div class="flex justify-between text-gray-600">
                <span>Tổng tạm tính</span>
                <span th:text="${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')} + 'đ'">0đ</span>
              </div>
              <div class="flex justify-between text-green-600" th:if="${discountAmount > 0}">
                <span>Tổng giảm giá</span>
                <span th:text="'-' + ${#numbers.formatDecimal(discountAmount, 0, 'COMMA', 0, 'POINT')} + 'đ'">-0đ</span>
              </div>
            </div>

            <div class="flex justify-between items-center mb-6">
              <span class="text-lg font-semibold text-gray-900">Tổng cộng</span>
              <span class="text-2xl font-bold text-blue-600"
                    th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + 'đ'">0đ</span>
            </div>

            <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transition">
              <i class="fas fa-check mr-2"></i>Xác nhận thanh toán
            </button>

            <a href="/customer/checkout/details" class="block w-full text-center text-blue-600 py-3 mt-3 hover:underline">
              <i class="fas fa-arrow-left mr-2"></i>Quay lại
            </a>

            <div class="mt-6 pt-6 border-t text-xs text-gray-500">
              <i class="fas fa-shield-alt mr-1 text-green-600"></i>Thông tin của bạn được bảo mật
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</main>

<div th:replace="~{layouts/footer :: siteFooter}"></div>

<script>
  anime({targets:'.bg-white',opacity:[0,1],translateY:[20,0],delay:anime.stagger(100),easing:'easeOutQuad'});
  document.querySelectorAll('input[name="paymentMethod"]').forEach(function(r){
    r.addEventListener('change', function(){
      document.querySelectorAll('.payment-method').forEach(function(el){ el.classList.remove('selected'); });
      r.closest('.payment-method')?.classList.add('selected');
    });
  });
  // Giữ highlight option đã chọn
  document.querySelectorAll('input[name="paymentMethod"]').forEach(function(r){
    r.addEventListener('change', function(){
      document.querySelectorAll('.payment-method').forEach(function(el){ el.classList.remove('selected'); });
      r.closest('.payment-method')?.classList.add('selected');
    });
  });
  document.querySelector('input[name="paymentMethod"]:checked')
    ?.closest('.payment-method')?.classList.add('selected');

  // Không đổi action. Chỉ kiểm tra đã chọn phương thức
  document.getElementById('checkoutForm').addEventListener('submit', function(e){
    var method = document.querySelector('input[name="paymentMethod"]:checked')?.value || '';
    if(!method){
      e.preventDefault();
      alert('Hãy chọn phương thức thanh toán.');
    }
  });
</script>
</body>
</html>
