<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lịch sử đơn hàng - VHBTV HomeCare</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <style>
    .gradient-text {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .status-badge {
        @apply inline-block px-3 py-1 text-xs font-semibold rounded-full;
    }
    .status-PENDING { @apply bg-yellow-100 text-yellow-800; }
    .status-CONFIRMED { @apply bg-blue-100 text-blue-800; }
    .status-IN_PROGRESS { @apply bg-purple-100 text-purple-800; }
    .status-COMPLETED { @apply bg-green-100 text-green-800; }
    .status-CANCELLED { @apply bg-red-100 text-red-800; }
  </style>
</head>
<body class="bg-gray-50">
<div th:replace="~{layouts/header :: siteHeader}"></div>

<main class="pt-24 pb-16">
  <div class="container mx-auto px-4 lg:px-8 max-w-6xl">
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        <i class="fas fa-history mr-2 text-blue-600"></i>
        Lịch sử đơn hàng
      </h1>
      <p class="text-gray-600">Quản lý và theo dõi tất cả đơn hàng của bạn</p>
    </div>

    <!-- Filter Tabs -->
    <div class="bg-white rounded-xl shadow-sm p-2 mb-6 flex gap-2 overflow-x-auto">
      <a href="?status=ALL"
         th:classappend="${currentStatus == 'ALL' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-100'}"
         class="px-4 py-2 rounded-lg font-medium whitespace-nowrap transition">
        Tất cả
        <span class="ml-1 text-sm" th:text="'(' + ${counts.all} + ')'"></span>
      </a>
      <a href="?status=PENDING"
         th:classappend="${currentStatus == 'PENDING' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-100'}"
         class="px-4 py-2 rounded-lg font-medium whitespace-nowrap transition">
        Chờ xác nhận
        <span class="ml-1 text-sm" th:text="'(' + ${counts.pending} + ')'"></span>
      </a>
      <a href="?status=CONFIRMED"
         th:classappend="${currentStatus == 'CONFIRMED' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-100'}"
         class="px-4 py-2 rounded-lg font-medium whitespace-nowrap transition">
        Đã xác nhận
        <span class="ml-1 text-sm" th:text="'(' + ${counts.confirmed} + ')'"></span>
      </a>
      <a href="?status=IN_PROGRESS"
         th:classappend="${currentStatus == 'IN_PROGRESS' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-100'}"
         class="px-4 py-2 rounded-lg font-medium whitespace-nowrap transition">
        Đang thực hiện
        <span class="ml-1 text-sm" th:text="'(' + ${counts.inProgress} + ')'"></span>
      </a>
      <a href="?status=COMPLETED"
         th:classappend="${currentStatus == 'COMPLETED' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-100'}"
         class="px-4 py-2 rounded-lg font-medium whitespace-nowrap transition">
        Hoàn thành
        <span class="ml-1 text-sm" th:text="'(' + ${counts.completed} + ')'"></span>
      </a>
      <a href="?status=CANCELLED"
         th:classappend="${currentStatus == 'CANCELLED' ? 'bg-blue-600 text-white' : 'text-gray-700 hover:bg-gray-100'}"
         class="px-4 py-2 rounded-lg font-medium whitespace-nowrap transition">
        Đã hủy
        <span class="ml-1 text-sm" th:text="'(' + ${counts.cancelled} + ')'"></span>
      </a>
    </div>

    <!-- Empty State -->
    <div th:if="${#lists.isEmpty(orders)}" class="text-center py-20">
      <div class="inline-block p-8 bg-white rounded-full shadow-lg mb-6">
        <i class="fas fa-inbox text-6xl text-gray-300"></i>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Chưa có đơn hàng nào</h2>
      <p class="text-gray-600 mb-8">Hãy khám phá và đặt dịch vụ ngay hôm nay</p>
      <a href="/services" class="inline-block bg-gradient-to-r from-blue-500 to-purple-600 text-white px-8 py-3 rounded-full font-medium hover:shadow-lg transition">
        <i class="fas fa-search mr-2"></i>Khám phá dịch vụ
      </a>
    </div>

    <!-- Orders List -->
    <div th:if="${!#lists.isEmpty(orders)}" class="space-y-4">
      <div th:each="order : ${orders}" class="bg-white rounded-xl shadow-sm hover:shadow-md transition">
        <!-- Order Header -->
        <div class="p-6 border-b">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <img th:src="${order.vendor.avatarUrl ?: '/placeholder.svg?height=48&width=48'}"
                   alt="Vendor" class="w-12 h-12 rounded-full object-cover">
              <div>
                <h3 class="font-semibold text-gray-900" th:text="${order.vendor.displayName}">Vendor Name</h3>
                <div class="flex items-center gap-2 text-sm text-gray-600">
                  <i class="fas fa-star text-yellow-400"></i>
                  <span th:text="${order.vendor.ratingAvg}">4.8</span>
                  <span th:if="${order.vendor.verified}" class="text-blue-600">
                                            <i class="fas fa-check-circle"></i>
                                        </span>
                </div>
              </div>
            </div>
            <div class="text-right">
              <div class="font-mono font-semibold text-blue-600 mb-1" th:text="${order.orderCode}">SO-V15-0001</div>
              <span class="status-badge" th:classappend="'status-' + ${order.status}" th:text="${order.statusDisplay}">Chờ xác nhận</span>
            </div>
          </div>

          <div class="grid md:grid-cols-3 gap-4 text-sm">
            <div>
              <span class="text-gray-600">Ngày đặt:</span>
              <span class="font-medium ml-2" th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}">21/09/2025 08:15</span>
            </div>
            <div>
              <span class="text-gray-600">Tổng tiền:</span>
              <span class="font-bold text-blue-600 ml-2" th:text="${#numbers.formatDecimal(order.total, 0, 'COMMA', 0, 'POINT')} + 'đ'">585,000đ</span>
            </div>
            <div>
              <span class="text-gray-600">Thanh toán:</span>
              <span class="font-medium ml-2" th:text="${order.paymentMethod}">VNPAY</span>
            </div>
          </div>
        </div>

        <!-- Order Items Preview -->
        <div class="p-6">
          <div th:each="item, iterStat : ${order.items}"
               th:if="${iterStat.index < 2}"
               class="flex gap-3 mb-3 last:mb-0">
            <img th:src="${item.vendorService.coverUrl ?: '/placeholder.svg?height=60&width=60'}"
                 alt="Service" class="w-16 h-16 rounded-lg object-cover">
            <div class="flex-1">
              <h4 class="font-medium text-gray-900" th:text="${item.vendorService.title}">Service</h4>
              <div class="text-sm text-gray-600 mt-1">
                <i class="fas fa-calendar mr-1"></i>
                <span th:text="${#temporals.format(item.scheduleAt, 'dd/MM/yyyy HH:mm')}">21/09/2025 09:00</span>
              </div>
            </div>
            <div class="text-right">
              <div class="text-sm text-gray-600">x<span th:text="${item.quantity}">1</span></div>
              <div class="font-semibold text-blue-600" th:text="${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT')} + 'đ'">350,000đ</div>
            </div>
          </div>
          <div th:if="${#lists.size(order.items) > 2}" class="text-sm text-gray-500 text-center mt-2">
            + <span th:text="${#lists.size(order.items) - 2}">1</span> dịch vụ khác
          </div>
        </div>

        <!-- Order Actions -->
        <div class="p-6 border-t bg-gray-50 flex gap-3">
          <a th:href="@{/customer/orders/detail/{id}(id=${order.id})}"
             class="flex-1 text-center border-2 border-blue-600 text-blue-600 py-2 rounded-lg font-medium hover:bg-blue-50 transition">
            <i class="fas fa-eye mr-2"></i>Xem chi tiết
          </a>
          <a th:if="${order.status == 'PENDING' or order.status == 'CONFIRMED'}"
             th:href="@{/customer/chat/order/{code}(code=${order.orderCode})}"
             class="flex-1 text-center bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700 transition">
            <i class="fas fa-comments mr-2"></i>Nhắn tin
          </a>
          <button th:if="${order.status == 'COMPLETED' and !order.reviewed}"
                  th:attr="data-order-id=${order.id}"
                  class="flex-1 bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 transition review-btn">
            <i class="fas fa-star mr-2"></i>Đánh giá
          </button>
          <button th:if="${order.status == 'PENDING'}"
                  th:attr="data-order-id=${order.id}"
                  class="flex-1 bg-red-600 text-white py-2 rounded-lg font-medium hover:bg-red-700 transition cancel-btn">
            <i class="fas fa-times mr-2"></i>Hủy đơn
          </button>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div th:if="${totalPages > 1}" class="mt-8 flex justify-center">
      <nav class="flex gap-2">
        <a th:if="${currentPage > 0}"
           th:href="@{/customer/orders/history(page=${currentPage - 1}, status=${currentStatus})}"
           class="px-4 py-2 border rounded-lg hover:bg-gray-50">
          <i class="fas fa-chevron-left"></i>
        </a>

        <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                        <a th:href="@{/customer/orders/history(page=${i}, status=${currentStatus})}"
                           th:classappend="${i == currentPage ? 'bg-blue-600 text-white' : 'border hover:bg-gray-50'}"
                           class="px-4 py-2 rounded-lg"
                           th:text="${i + 1}">1</a>
                    </span>

        <a th:if="${currentPage < totalPages - 1}"
           th:href="@{/customer/orders/history(page=${currentPage + 1}, status=${currentStatus})}"
           class="px-4 py-2 border rounded-lg hover:bg-gray-50">
          <i class="fas fa-chevron-right"></i>
        </a>
      </nav>
    </div>
  </div>
</main>

<div th:replace="~{layouts/footer :: siteFooter}"></div>

<script>
  anime({
      targets: '.bg-white',
      opacity: [0, 1],
      translateY: [20, 0],
      delay: anime.stagger(100),
      easing: 'easeOutQuad'
  });

  // Cancel order
  document.querySelectorAll('.cancel-btn').forEach(btn => {
      btn.addEventListener('click', function() {
          if (confirm('Bạn có chắc muốn hủy đơn hàng này?')) {
              const orderId = this.dataset.orderId;
              fetch(`/api/orders/${orderId}/cancel`, { method: 'POST' })
                  .then(() => location.reload());
          }
      });
  });

  // Review order
  document.querySelectorAll('.review-btn').forEach(btn => {
      btn.addEventListener('click', function() {
          const orderId = this.dataset.orderId;
          window.location.href = `/customer/orders/${orderId}/review`;
      });
  });
</script>
</body>
</html>
