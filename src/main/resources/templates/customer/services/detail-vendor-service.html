<!-- resources/templates/customer/services/detail-vendor-service.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title th:text="${vendorService != null ? vendorService.title : 'Dịch vụ'}">Dịch vụ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">
    <!-- tránh 404 favicon -->
    <link rel="icon" href="data:,">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .card { background: linear-gradient(145deg,#ffffff,#f8fafc); border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,.06); }
        .thumb-active { outline: 2px solid #2563eb; outline-offset: 2px; }
        .ratio-16x9 { position: relative; width: 100%; }
        .ratio-16x9::before { content:""; display:block; padding-top:56.25%; }
        .ratio-16x9 > .fit { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
        /* modal */
        .modal-show { opacity: 1; pointer-events: auto; }
        .modal-hide { opacity: 0; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-50">

<th:block th:replace="layouts/header :: siteHeader"></th:block>

<main class="container mx-auto px-4 lg:px-8 pt-28 pb-16">

    <nav class="text-sm text-gray-600 mb-6">
        <a href="/" class="hover:text-blue-600"><i class="fa fa-home mr-1"></i>Trang chủ</a>
        <span class="mx-2 text-gray-400">/</span>
        <a th:if="${service != null}" th:href="@{'/services/' + ${service.slug} + '/vendors'}" class="hover:text-blue-600" th:text="${service.name}">Dịch vụ</a>
        <span class="mx-2 text-gray-400">/</span>
        <span class="font-semibold" th:text="${vendorService.title}">Chi tiết</span>
    </nav>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <div class="lg:col-span-2 card p-6">
            <div class="flex items-start justify-between">
                <div>
                    <h1 class="text-3xl font-extrabold mb-2" th:text="${vendorService.title}">Tiêu đề dịch vụ</h1>
                    <div class="flex items-center text-gray-600 space-x-4">
                        <div><i class="fa fa-stopwatch mr-1"></i><span th:text="${vendorService.durationMinutes} + ' phút'">90 phút</span></div>
                        <div><i class="fa fa-bell mr-1"></i><span th:text="'Báo trước ' + (${vendorService.minNoticeHours} ?: 0) + ' giờ'">Báo trước</span></div>
                        <div><i class="fa fa-shopping-bag mr-1"></i><span th:text="${ordersCount} + ' đơn đã đặt'">0 đơn đã đặt</span></div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-bold text-blue-700">
                        <span th:text="${#numbers.formatDecimal(vendorService.basePrice,0,'POINT',0,'POINT')}">0</span>
                        <span class="text-sm text-gray-600" th:text="' / ' + (${vendorService.unit} ?: 'lần')">/ lần</span>
                    </div>
                    <button id="js-like-svc"
                            class="mt-2 text-red-500 hover:text-red-600"
                            th:attr="data-svc-id=${vendorService.id}"
                            aria-pressed="false">
                        <i class="fa-regular fa-heart mr-1"></i> <span>Yêu thích</span>
                    </button>
                </div>
            </div>

            <div class="mt-6">
                <div class="ratio-16x9 bg-gray-200 rounded-xl overflow-hidden">
                    <img id="js-main"
                         class="fit"
                         alt="gallery"
                         th:src="${!#lists.isEmpty(imageList) ? imageList.get(0).url : (vendorService.coverUrl != null ? vendorService.coverUrl : '')}">
                </div>

                <div class="mt-3 flex space-x-2 overflow-x-auto pb-1">
                    <img th:each="m,iter : ${imageList}"
                         th:src="${m.url}"
                         th:attr="data-src=${m.url}"
                         th:alt="${m.altText}"
                         class="js-thumb w-24 h-16 object-cover rounded-lg cursor-pointer hover:opacity-90">
                </div>

                <div th:if="${#lists.isEmpty(imageList) && vendorService.coverUrl == null}" class="w-full h-64 bg-gray-200 rounded-xl flex items-center justify-center text-gray-500 mt-3">
                    Chưa có ảnh
                </div>
            </div>

            <div class="mt-6 prose max-w-none">
                <h2 class="text-xl font-semibold mb-2">Mô tả dịch vụ</h2>
                <p th:utext="${#strings.escapeXml(vendorService.description) ?: 'Đang cập nhật'}">Đang cập nhật</p>
            </div>

            <div class="mt-6" th:if="${!#lists.isEmpty(mediaList)}">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    <div th:each="m : ${mediaList}" th:if="${m.mediaType.name() == 'VIDEO'}" class="relative group">
                        <div class="w-full h-40 bg-black rounded-lg flex items-center justify-center text-white">
                            <i class="fa fa-play mr-2"></i><span th:text="${m.altText}">Video</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <aside class="card p-6 space-y-6">
            <div>
                <h3 class="text-lg font-semibold mb-2">Nhà cung cấp</h3>

                <div class="flex items-center">
                    <a class="w-12 h-12 rounded-full bg-gray-200 mr-3 overflow-hidden block"
                       th:href="@{/vendors/{name}(name=${vendorDisplayName})}">
                        <img th:if="${vendorAvatarUrl}" th:src="${vendorAvatarUrl}" alt="avatar" class="w-12 h-12 object-cover">
                    </a>

                    <div>
                        <div class="font-semibold">
                            <a th:href="@{/vendors/{name}(name=${vendorDisplayName})}"
                               th:text="${vendorDisplayName}">Vendor</a>
                            <i th:if="${vendorVerified}" class="fa fa-badge-check text-blue-600 ml-1"></i>
                        </div>
                        <div class="text-sm text-gray-600">
                            <i class="fa fa-star text-yellow-400 mr-1"></i>
                            <span th:text="${#numbers.formatDecimal(vendorAvgRating,1,1)}">0.0</span>
                            <span th:text="'(' + ${vendorRatingCount} + ' đánh giá)'">(0 đánh giá)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-lg font-semibold mb-2">Đặt lịch</h3>
                <div sec:authorize="isAnonymous()" class="space-y-3">
                    <p class="text-gray-600 text-sm">Bạn cần đăng nhập để thêm vào giỏ hàng.</p>
                    <a class="login-next block w-full text-center bg-blue-600 hover:bg-blue-700 text-white py-2 rounded"
                       sec:authorize="isAnonymous()"
                       th:href="@{/login}">
                        <i class="fa fa-sign-in-alt mr-1"></i>Đăng nhập
                    </a>
                </div>

                <form sec:authorize="isAuthenticated()" method="post" th:action="@{/customer/cart/items}">
                    <input type="hidden" name="vendorServiceId" th:value="${vendorService.id}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                    <label class="block text-sm text-gray-700 mb-1">Thời gian mong muốn</label>
                    <input type="datetime-local" name="scheduleAt" class="w-full border rounded px-3 py-2 mb-3">

                    <label class="block text-sm text-gray-700 mb-1">Số lượng</label>
                    <input id="qty" type="number" name="quantity" value="1" min="1" class="w-full border rounded px-3 py-2">

                    <div class="mt-4 p-3 bg-gray-100 rounded flex items-center justify-between">
                        <span class="text-gray-600">Tạm tính</span>
                        <strong id="pricePreview" class="text-blue-700" th:attr="data-price=${vendorService.basePrice}">0</strong>
                        <span class="text-sm text-gray-500" th:text="'/ ' + (${vendorService.unit} ?: 'lần')"></span>
                    </div>

                    <div class="mt-4 grid grid-cols-2 gap-3">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded">
                            <i class="fa fa-cart-plus mr-1"></i>Thêm vào giỏ
                        </button>
                        <a th:href="@{|/customer/checkout/details?vendorServiceId=${vendorService.id}&quantity=1|}"
                           class="text-center bg-green-600 hover:bg-green-700 text-white py-2 rounded">Đặt ngay</a>
                    </div>
                </form>
            </div>
        </aside>
    </section>

    <!-- KHỐI ĐÁNH GIÁ DỊCH VỤ -->
    <section class="card p-6 mt-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Đánh giá dịch vụ</h2>
            <div class="text-gray-600">
                <i class="fa fa-star text-yellow-400 mr-1"></i>
                <span th:text="${#numbers.formatDecimal(avgRating,1,1)}">0.0</span>
                <span th:text="'(' + ${ratingCount} + ' lượt)'">(0 lượt)</span>
            </div>
        </div>

        <!-- FORM: chỉ hiện nếu đăng nhập và có ServiceOrderItem đủ điều kiện -->
        <div sec:authorize="isAuthenticated()">
            <div th:if="${#lists.isEmpty(eligibleItems)}"
                 class="p-4 mb-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm">
                Bạn chưa có mục dịch vụ <span class="font-medium">đã hoàn tất</span> để đánh giá.
                Hãy hoàn tất đơn trước khi gửi đánh giá.
            </div>

            <form th:if="${!#lists.isEmpty(eligibleItems)}"
                  id="svcReviewForm" method="post" class="mb-6 space-y-4">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <!-- soItemId được gắn vào action động khi submit -->
                <div>
                    <label class="block text-sm text-gray-700 mb-1">Chọn mục đã sử dụng</label>
                    <select id="svcItemSelect"
                            class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Chọn mục dịch vụ đã hoàn tất --</option>
                        <option th:each="it : ${eligibleItems}"
                                th:value="${it.id}"
                                th:text="${#temporals.format(it.scheduledAt,'dd/MM/yyyy HH:mm')} + ' · ' + ${it.vendorService.title}">
                            01/01/2025 09:00 · Vệ sinh sofa
                        </option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-700 mb-1">Đánh giá</label>
                    <div id="svcStarBox" class="flex items-center space-x-1 text-2xl">
                        <i class="fa-regular fa-star text-gray-300 cursor-pointer" data-rate="1"></i>
                        <i class="fa-regular fa-star text-gray-300 cursor-pointer" data-rate="2"></i>
                        <i class="fa-regular fa-star text-gray-300 cursor-pointer" data-rate="3"></i>
                        <i class="fa-regular fa-star text-gray-300 cursor-pointer" data-rate="4"></i>
                        <i class="fa-regular fa-star text-gray-300 cursor-pointer" data-rate="5"></i>
                    </div>
                    <input id="svcRating" type="hidden" name="rating" value="0">
                </div>

                <div>
                    <label class="block text-sm text-gray-700 mb-1">Nhận xét</label>
                    <textarea name="content" rows="4"
                              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Chia sẻ trải nghiệm của bạn…"></textarea>
                </div>

                <div class="flex justify-end">
                    <button type="submit"
                            class="px-5 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium">
                        Gửi đánh giá
                    </button>
                </div>
            </form>
        </div>

        <!-- DANH SÁCH REVIEW -->
        <div th:if="${#lists.isEmpty(reviewsPage?.content)}" class="text-gray-500">Chưa có đánh giá.</div>

        <div th:each="r : ${reviewsPage?.content}" class="border-t py-4">
            <div class="flex items-center text-sm text-gray-600">
                <i class="fa fa-user mr-2"></i>
                <span th:text="${customerNamesById[r.customerId] ?: 'Khách hàng'}">Khách hàng</span>
                <span class="mx-2">•</span>
                <span>
                  <i class="fa fa-star text-yellow-400 mr-1"></i>
                  <span th:text="${r.rating}">5</span>
                </span>
                <span class="mx-2">•</span>
                <span th:text="${#temporals.format(r.createdAt, 'dd/MM/yyyy HH:mm')}">01/10/2025</span>
            </div>
            <div class="mt-2 text-gray-800" th:text="${r.content}">Nội dung...</div>
        </div>

        <div class="mt-4 flex justify-end space-x-2" th:if="${reviewsPage != null}">
            <a th:if="${!reviewsPage.first}" th:href="@{|/vendor-services/${vendorService.id}?page=${reviewsPage.number-1}&size=${reviewsPage.size}|}" class="px-3 py-1 border rounded">Trước</a>
            <span class="px-3 py-1">Trang <span th:text="${reviewsPage.number+1}">1</span>/<span th:text="${reviewsPage.totalPages}">1</span></span>
            <a th:if="${!reviewsPage.last}" th:href="@{|/vendor-services/${vendorService.id}?page=${reviewsPage.number+1}&size=${reviewsPage.size}|}" class="px-3 py-1 border rounded">Sau</a>
        </div>
    </section>

</main>

<th:block th:replace="layouts/footer :: siteFooter"></th:block>

<!-- MODAL THÔNG BÁO ĐƠN GIẢN -->
<div id="notifyModal" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 modal-hide transition-opacity duration-200">
    <div class="bg-white rounded-2xl shadow-xl w-[90%] max-w-md p-6">
        <div class="flex items-center gap-3 mb-3">
            <div id="notifyIcon" class="w-9 h-9 rounded-full flex items-center justify-center bg-green-100 text-green-600">
                <i class="fas fa-check"></i>
            </div>
            <h3 id="notifyTitle" class="text-lg font-semibold">Thành công</h3>
        </div>
        <p id="notifyMessage" class="text-gray-700 mb-5">Đã thêm vào giỏ hàng.</p>
        <div class="flex justify-end gap-2">
            <a href="/customer/cart" class="px-4 py-2 bg-blue-600 text-white rounded-lg">Xem giỏ hàng</a>
            <button id="notifyOk" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg">Đóng</button>
        </div>
    </div>
</div>

<script>
    (function(){
      var qty=document.getElementById('qty'), pv=document.getElementById('pricePreview');
      if(qty&&pv){
        var price=parseFloat(pv.dataset.price||'0');
        function upd(){ pv.textContent=(price*(parseInt(qty.value||'1'))).toLocaleString('vi-VN'); }
        qty.addEventListener('input',upd); upd();
      }
    })();

    (function(){
      var main=document.getElementById('js-main');
      var thumbs=[].slice.call(document.querySelectorAll('.js-thumb'));
      if(!main) return;
      var hasAnime=typeof window.anime==='function', idx=0, timer=null, D=4000, F=250;
      function hi(i){ thumbs.forEach(function(t,k){ t.classList.toggle('thumb-active', k===i); }); }
      function set(src,cb){
        if(!hasAnime){ main.src=src; cb&&cb(); return; }
        anime({targets:main,opacity:[1,0],duration:F,easing:'easeInOutQuad',complete:function(){
          main.src=src; anime({targets:main,opacity:[0,1],duration:F,easing:'easeInOutQuad',complete:cb});
        }});
      }
      function show(i,u){ if(!thumbs.length) return; idx=i; var src=thumbs[i].dataset.src||thumbs[i].src; hi(i); set(src,function(){ if(u) reset(); }); }
      function next(){ if(thumbs.length) show((idx+1)%thumbs.length,false); }
      function reset(){ if(timer) clearInterval(timer); timer=setInterval(next,D); }
      thumbs.forEach(function(t,i){ t.addEventListener('click',function(){ show(i,true); }); });
      hi(0); reset();
    })();

    // cập nhật link đăng nhập: /login?next=
    document.addEventListener('DOMContentLoaded', function(){
      var next=location.pathname+location.search;
      document.querySelectorAll('a.login-next').forEach(function(a){
        a.setAttribute('href','/login?next='+encodeURIComponent(next));
      });
    });

    // modal helpers
    (function(){
      var $m = document.getElementById('notifyModal');
      var $ok = document.getElementById('notifyOk');
      window.showModal = function(title, msg, type){
        document.getElementById('notifyTitle').textContent = title || 'Thông báo';
        document.getElementById('notifyMessage').textContent = msg || '';
        var $icon = document.getElementById('notifyIcon');
        $icon.className = 'w-9 h-9 rounded-full flex items-center justify-center';
        if(type==='success'){ $icon.classList.add('bg-green-100','text-green-600'); $icon.innerHTML='<i class="fas fa-check"></i>'; }
        else if(type==='error'){ $icon.classList.add('bg-red-100','text-red-600'); $icon.innerHTML='<i class="fas fa-times"></i>'; }
        else { $icon.classList.add('bg-blue-100','text-blue-600'); $icon.innerHTML='<i class="fas fa-info"></i>'; }
        $m.classList.remove('modal-hide'); $m.classList.add('modal-show');
      };
      window.hideModal = function(){ $m.classList.remove('modal-show'); $m.classList.add('modal-hide'); };
      $ok.addEventListener('click', hideModal);
      $m.addEventListener('click', function(e){ if(e.target===$m) hideModal(); });
    })();

    // submit form: hiển thị modal "thêm vào giỏ hàng thành công"
    (function(){
      function csrfHeaders(){
        var h=document.querySelector('meta[name="_csrf_header"]')?.content;
        var t=document.querySelector('meta[name="_csrf"]')?.content;
        var o={'Content-Type':'application/x-www-form-urlencoded'}; if(h&&t) o[h]=t; return o;
      }
      document.addEventListener('DOMContentLoaded', function(){
        var form=document.querySelector('form[action$="/customer/cart/items"]');
        if(!form) return;
        form.addEventListener('submit', function(e){
          e.preventDefault();
          var fd=new FormData(form);
          var q=fd.get('quantity'); if(!q||+q<1) fd.set('quantity','1');
          var body=new URLSearchParams(); fd.forEach(function(v,k){ body.append(k,v); });
          fetch('/customer/cart/items', {
            method:'POST',
            headers: csrfHeaders(),
            body: body.toString(),
            credentials: 'same-origin'
          })
          .then(function(r){ if(!r.ok) throw r; return r.json(); })
          .then(function(){ showModal('Thành công', 'Đã thêm vào giỏ hàng.', 'success'); })
          .catch(function(){ showModal('Lỗi', 'Không thể thêm vào giỏ hàng.', 'error'); });
        });
      });
    })();
    (function(){
  function csrf(){ const h=document.querySelector('meta[name="_csrf_header"]')?.content;
                   const t=document.querySelector('meta[name="_csrf"]')?.content;
                   const o={'Accept':'application/json'}; if(h&&t) o[h]=t; return o; }
  function setLiked(btn, liked){
    btn.setAttribute('aria-pressed', liked?'true':'false');
    const i=btn.querySelector('i'); if(!i) return;
    i.classList.toggle('fa-regular', !liked);
    i.classList.toggle('fa-solid', liked);
    i.classList.toggle('text-red-500', liked);
  }
  async function getStatus(id){
    const r = await fetch(`/customer/wishlist/services/${id}/status`, {credentials:'same-origin'});
    if(!r.ok) return false; const j = await r.json(); return !!j.liked;
  }
  async function add(id){
    const r = await fetch(`/customer/wishlist/services/${id}`, {method:'POST', headers:csrf(), credentials:'same-origin'});
    if(r.status===401||r.status===403) { location.href='/login?next='+encodeURIComponent(location.pathname+location.search); return false; }
    return r.ok;
  }
  async function remove_(id){
    const r = await fetch(`/customer/wishlist/services/${id}`, {method:'DELETE', headers:csrf(), credentials:'same-origin'});
    if(r.status===401||r.status===403) { location.href='/login?next='+encodeURIComponent(location.pathname+location.search); return false; }
    return r.ok;
  }

  document.addEventListener('DOMContentLoaded', async function(){
    const btn=document.getElementById('js-like-svc'); if(!btn) return;
    const id=btn.dataset.svcId;
    try { setLiked(btn, await getStatus(id)); } catch(e){}
    btn.addEventListener('click', async function(e){
      e.preventDefault();
      const liked = btn.getAttribute('aria-pressed')==='true';
      const ok = liked ? await remove_(id) : await add(id);
      if(ok){ setLiked(btn, !liked); if(window.anime) anime({targets:btn.querySelector('i'), scale:[1,1.25,1], duration:350, easing:'easeOutElastic(1,.6)'}); }
    });
  });
})();
    /* ===== STAR WIDGET + SUBMIT REVIEW (SERVICE) ===== */
(function(){
  function paintStars(box, n){
    box.querySelectorAll('[data-rate]').forEach(function(i){
      var on = Number(i.dataset.rate) <= Number(n);
      i.classList.toggle('fa-solid', on);
      i.classList.toggle('fa-regular', !on);
      i.classList.toggle('text-yellow-400', on);
      i.classList.toggle('text-gray-300', !on);
    });
  }
  document.addEventListener('DOMContentLoaded', function(){
    var box = document.getElementById('svcStarBox');
    var input = document.getElementById('svcRating');
    if(box && input){
      paintStars(box, input.value||0);
      box.querySelectorAll('[data-rate]').forEach(function(i){
        i.addEventListener('mouseenter', function(){ paintStars(box, i.dataset.rate); });
        i.addEventListener('mouseleave', function(){ paintStars(box, input.value||0); });
        i.addEventListener('click', function(){
          input.value = i.dataset.rate;
          paintStars(box, input.value);
          if(window.anime){ anime({targets:i, scale:[1,1.2,1], duration:300, easing:'easeOutElastic(1,.6)'}); }
        });
      });
    }

    var form = document.getElementById('svcReviewForm');
    var sel  = document.getElementById('svcItemSelect');
    if(form && sel){
      form.addEventListener('submit', function(e){
        var soItemId = sel.value;
        var rating = Number((document.getElementById('svcRating')||{}).value||0);
        if(!soItemId){ e.preventDefault(); alert('Hãy chọn mục đã sử dụng.'); return; }
        if(rating<1 || rating>5){ e.preventDefault(); alert('Hãy chọn số sao 1..5.'); return; }
        form.action = '/customer/reviews/service/' + encodeURIComponent(soItemId);
      });
    }
  });
})();
</script>
</body>
</html>
