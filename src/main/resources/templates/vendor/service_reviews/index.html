<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Đánh giá dịch vụ | Vendor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>*{font-family:'Inter',sans-serif}.sidebar-active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}</style>
</head>
<body class="bg-gray-50">

<!-- Header -->
<div th:replace="vendor/layouts/header :: vendorHeader"></div>

<div class="flex">
    <!-- Sidebar -->
    <div th:replace="vendor/layouts/sidebar :: vendorSidebar"></div>

    <!-- Main -->
    <main class="flex-1 p-6">
        <!-- Tiêu đề + bộ lọc -->
        <div class="flex items-center justify-between mb-4">
            <h1 class="text-2xl font-bold">Đánh giá dịch vụ</h1>

            <form class="flex items-center space-x-2" th:action="@{/vendor/service-reviews}" method="get">
                <!-- Dịch vụ -->
                <select name="serviceId" class="border rounded-lg px-3 py-2">
                    <option value="" th:selected="${q_serviceId==null}">Tất cả dịch vụ</option>
                    <option th:each="s : ${services}"
                            th:value="${s.id}"
                            th:text="${s.title}"
                            th:selected="${q_serviceId!=null and q_serviceId==s.id}">Dịch vụ</option>
                </select>

                <!-- Rating -->
                <input type="number" name="ratingMin" min="1" max="5" class="border rounded-lg px-3 py-2 w-20"
                       placeholder="Min" th:value="${q_ratingMin}">
                <input type="number" name="ratingMax" min="1" max="5" class="border rounded-lg px-3 py-2 w-20"
                       placeholder="Max" th:value="${q_ratingMax}">

                <!-- Ngày -->
                <input type="date" name="from" class="border rounded-lg px-3 py-2" th:value="${q_from}">
                <input type="date" name="to" class="border rounded-lg px-3 py-2" th:value="${q_to}">

                <!-- Từ khóa -->
                <input type="text" name="keyword" th:value="${q_keyword}" placeholder="Tìm theo nội dung"
                       class="border rounded-lg px-3 py-2 w-64">

                <!-- Ẩn hiện -->
                <label class="inline-flex items-center space-x-2 text-sm text-gray-700 ml-2">
                    <input type="checkbox" name="includeHidden" th:checked="${q_includeHidden}" class="rounded">
                    <span>Hiển thị cả đánh giá ẩn</span>
                </label>

                <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg">
                    <i class="fas fa-search mr-1"></i>Tìm
                </button>
            </form>
        </div>

        <!-- Thống kê -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm border p-4">
                <p class="text-sm text-gray-600">Điểm trung bình</p>
                <div class="flex items-baseline space-x-2 mt-1">
                    <span class="text-3xl font-bold text-gray-900" th:text="${#numbers.formatDecimal(summary.avg,1,2)}">0.00</span>
                    <span class="text-yellow-500"><i class="fa-solid fa-star"></i></span>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border p-4">
                <p class="text-sm text-gray-600">Tổng số đánh giá</p>
                <p class="text-3xl font-bold text-gray-900 mt-1" th:text="${summary.total}">0</p>
            </div>

            <div class="bg-white rounded-xl shadow-sm border p-4">
                <p class="text-sm text-gray-600 mb-2">Phân bố sao</p>
                <div th:if="${summary.total>0}" class="space-y-1">
                    <div th:each="h : ${summary.histogram}">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-700" th:text="|${h[0]}★|">5★</span>
                            <span class="text-gray-500" th:text="|${#numbers.formatDecimal((h[1]*100.0)/summary.total,1,1)}%|">0%</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2">
                            <div class="h-2 rounded-full bg-indigo-500"
                                 th:style="|width:${(h[1]*100.0)/summary.total}%|"></div>
                        </div>
                    </div>
                </div>
                <p th:if="${summary.total==0}" class="text-sm text-gray-500">Chưa có dữ liệu.</p>
            </div>
        </div>

        <!-- Top dịch vụ -->
        <div class="bg-white rounded-xl shadow-sm border mb-6">
            <div class="px-4 py-3 border-b">
                <h2 class="font-semibold text-gray-900">Top dịch vụ theo điểm trung bình</h2>
            </div>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Dịch vụ</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Điểm TB</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Số đánh giá</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                <tr th:each="t : ${summary.topServices}">
                    <td class="px-4 py-3">
                        <!-- chỉ còn map svcNames -->
                        <span th:with="sid=${t[0]}, name=${svcNames[sid]}"
                              th:text="${name != null ? name : 'ID: ' + sid}">Dịch vụ</span>
                    </td>
                    <td class="px-4 py-3 text-right" th:text="${#numbers.formatDecimal(t[1],1,2)}">0.00</td>
                    <td class="px-4 py-3 text-right" th:text="${t[2]}">0</td>
                    <td class="px-4 py-3 text-right">
                        <a th:href="@{|/vendor/service-reviews/${t[0]}|}" class="px-3 py-2 border rounded-lg text-gray-700 hover:bg-gray-50">
                            Xem
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Danh sách đánh giá -->
        <div class="bg-white rounded-xl shadow-sm border">
            <div class="px-4 py-3 border-b flex items-center justify-between">
                <h2 class="font-semibold text-gray-900">Tất cả đánh giá</h2>
            </div>

            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Dịch vụ</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">Điểm</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Nội dung</th>
                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600">Ngày</th>
                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600">Trạng thái</th>
                    <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600">Hành động</th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                <tr th:each="r : ${reviews}">
                    <td class="px-4 py-3">
            <span th:with="sid=${r.vendorServiceId}, name=${svcNames[sid]}"
                  th:text="${name != null ? name : 'ID: ' + sid}">Dịch vụ</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="font-semibold text-gray-900" th:text="${r.rating}">5</span>
                        <span class="text-yellow-500"><i class="fa-solid fa-star"></i></span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-gray-700" style="-webkit-line-clamp:2;display:-webkit-box;-webkit-box-orient:vertical;overflow:hidden;">
                            <span th:text="${r.content}">Nội dung nhận xét...</span>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-gray-700" th:text="${#temporals.format(r.createdAt,'dd/MM/yyyy HH:mm')}">01/10/2025 12:00</td>
                    <td class="px-4 py-3 text-center">
                        <span th:if="${r.hidden}" class="px-2 py-1 rounded-full text-xs bg-gray-200 text-gray-700">Ẩn</span>
                        <span th:unless="${r.hidden}" class="px-2 py-1 rounded-full text-xs bg-green-50 text-green-700">Hiển thị</span>
                    </td>
                    <td class="px-4 py-3 text-right space-x-2">
                        <form th:action="@{|/vendor/service-reviews/${r.id}/hide|}" method="post" class="inline">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <input type="hidden" name="redirect" value="/vendor/service-reviews">
                            <input type="hidden" name="value" th:value="${!r.hidden}">
                            <button class="px-3 py-2 rounded-lg"
                                    th:classappend="${r.hidden} ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-200 text-gray-800 hover:bg-gray-300'">
                                <span th:text="${r.hidden ? 'Hiện' : 'Ẩn'}">Ẩn</span>
                            </button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="flex items-center justify-between px-4 py-3">
                <div class="text-sm text-gray-600" th:text="|Trang ${reviews.number + 1} / ${reviews.totalPages}|">Trang 1/1</div>
                <div class="space-x-2">
                    <a th:if="${reviews.hasPrevious()}"
                       th:href="@{/vendor/service-reviews(
                 page=${reviews.number - 1},
                 size=${reviews.size},
                 serviceId=${q_serviceId},
                 ratingMin=${q_ratingMin},
                 ratingMax=${q_ratingMax},
                 from=${q_from},
                 to=${q_to},
                 keyword=${q_keyword},
                 includeHidden=${q_includeHidden}
               )}"
                       class="px-3 py-2 border rounded-lg text-gray-700">Trước</a>
                    <a th:if="${reviews.hasNext()}"
                       th:href="@{/vendor/service-reviews(
                 page=${reviews.number + 1},
                 size=${reviews.size},
                 serviceId=${q_serviceId},
                 ratingMin=${q_ratingMin},
                 ratingMax=${q_ratingMax},
                 from=${q_from},
                 to=${q_to},
                 keyword=${q_keyword},
                 includeHidden=${q_includeHidden}
               )}"
                       class="px-3 py-2 border rounded-lg text-gray-700">Sau</a>
                </div>
            </div>
        </div>
    </main>
</div>
</body>
</html>
